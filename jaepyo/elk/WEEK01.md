## 기본 구성 개념

인덱스

- document를 저장하는 논리적인 공간.
- 즉, 하나의 데이터를 이루는 논리적 개념
- 하나의 인덱스는 여러 샤드로 구성되어 있다.

노드

- 실행중인 하나의 서버
- 클러스터의 구성단위로, 데이터를 저장하고 쿼리 처리
- 한 노드는 여러 샤드를 가질수 있다.

샤드

- 인덱스를 분할한 실제 저장 단위
- 하나의 인덱스의 데이터를 분할해, 서로다른 노드의 샤드들이 나눠가지고 있다.
- 샤드는 두종류가 있다. “프라이머리 샤드”, “레플리카 샤드”
    - 프라이머리 샤드와 레플리카 샤드는 동일한 값, 서로 다른 샤드는 같은 인덱스의 데이터를 나눠가짐
    - 분할저장덕분에 병렬처리가 가능함.

## CRUD

Create

- post를 통해 조회가능한데, ID를 기준으로 우선 뽑게된다.

Read
- id를 기반으로 인덱스를 조회한다.

Update

- 기존의 다큐먼트에서 새로운 버전의 document를 바라보게 한다.
- 수정하기 위해서는 doc키워드를 쓰고, 내부에서 필드와 값을 사용해야 한다. 그러지 않으면 값이 아닌 document 전체가 바뀌게 된다.

Delete

- 삭제는 기존의 다큐먼트를 바로 지우는 것이 아닌, 삭제 마크를 하고 추후에 삭제된다. 만약 바로 지우고 싶다면 flush를 하면 된다.

<br>

일라스틱 서치는 **불변**이다. 불변이기 때문에 얻을수 있는 이점은 아래와 같다.

- 일관성 보장
- 삭제 또는 변경시 참조를 바꾸면 되기 때문에 모든 데이터의 필드를 수정해주는 작업으로 인한 지연이 없다.
- 불변이기 때문에 캐싱에 유리하다.

이외에도 일라스틱 서치는 Upsert가 가능하고, Script기능으로 필드에 로직을 추가할수 있다.

## 라우팅

엘라스틱서치가 인덱스를 구성하는 샤드 중 몇번 샤드를 대상으로 작업을 수행할지 지정하기 위해 사용한 값. 즉 샤드를 찾는 작업

- 작업대상 샤드를 지정하지 않으면 지정된 라우팅 값을 해시한 후 주 샤드의 개수로  나머지 연산을 수행해 값을 얻음

샤드의 장점

- 지역성이 올라가 성능이 빨라질수 있다.

샤드의 단점

- 하나의 샤드에 모든 데이터를 넣는다면(한 노드만 데이터가 많아지는 상황), 샤드가 인발란스하게 됌.
- 라우팅 키를 바꿀수 없다.

## Read하는 로직

1. 클라이언트가 일라스틱서치에게 쿼리요청
2. 코디네이트 노드가 요청을 받음
3. 요청 대상이 될 샤드를 조회
    - ARS알고리즘을 통해 라우팅하게됌.
    - ARS는 서버중 가장 응답을 잘하는 샤드를 찾으면 빠르게 응답할수 있을텐데, 이것을 미리 계산하는것.
4. 각 샤드에게 병렬로 쿼리 실행 요청
5. 샤드들이 쿼리 결과 반환
6. 코디네이팅 노드가 결과를 취합하고 정렬, 집계 등의 후처리
7. 최종 결과를 클라이언트에 응답

<aside>
💡

하나의 인덱스는 여러개의 샤드로 분산되어 있다. 따라서 인덱스를 조회하기 위해 분산된 샤드를 병렬로 쿼리 실행한후, 코디네이트 노드에서 집계한다.

</aside>

## Write하는 로직

1. 클라이언트가 요청을 보냄
2. document아이디를 해싱하여 작성이 될 샤드를 선택
3. 프라이머리 샤드에 쓰기 수행
4. 해당 샤드를 가진 노드에게 요청 전달
5. 시퀀스 넘버와 프라이머리 텀 기록
6. translog에 로그를 남김
7. 레플리카 샤드에 복제
8. 클라이언트에 성공응답

<aside>
💡

시퀀스 넘버: 해당 샤드에서 실행된 각 쓰기의 유니크 번호
프라이머리 텀: 프라이머리 노드에 장애발생시, 레플리카 노드가 승격되고 이때 부여받는 값

</aside>

## 동시성 해결

동시성은 읽기가 아닌 쓰기 작업시에 발생하는 문제이다.

쓰기작업을 진행할때 시퀀스 넘버와 프라이머리 텀을 함께 전송하여 동시성을 해결한다

```jsx
PUT /my-index/_doc/1?if_seq_no=10&if_primary_term=2
```

- 만약 요청했을때 시퀀스넘버와 프라이머리텀이 document와 동일하다면 작업이 허용되지만 다르다면 409Conflict를 전달

따라서 보통 에러를 반환받은 뒤, 애플리케이션 단에서 재전송과 같이 처리를 하게된다.
